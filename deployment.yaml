# -------------------------------------------------------------------
# 1. DEPLOYMENT (Application)
# -------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: social-score-deployment
  labels:
    app: social-score-api
spec:
  replicas: 3 # Nombre de Pods de base
  selector:
    matchLabels:
      app: social-score-api
  template:
    metadata:
      labels:
        app: social-score-api
    spec:
      # AJOUT DE LA SÉCURITÉ : Exécuter en tant qu'utilisateur non-root
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000 # Assure que le groupe a les droits sur les volumes si nécessaire
      containers:
      - name: social-score-container
        image: us-west1-docker.pkg.dev/digital-social-score/digital-social-score/social-score-api:v1.4
        ports:
        - containerPort: 8080
        
        # CORRECTION 1 : ReadinessProbe et LivenessProbe doivent utiliser le même port (8080)
        # CORRECTION 2 : La LivenessProbe doit être plus tolérante que la ReadinessProbe
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10 # Attendre 10s avant de commencer à vérifier
          periodSeconds: 5        # Vérifier toutes les 5s
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30 # Attendre 30s avant de commencer (laisse le temps de charger le modèle )
          periodSeconds: 10       # Vérifier toutes les 10s
          failureThreshold: 5     # Tolérer 5 échecs avant de redémarrer
          
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
            
        # CORRECTION 3 : Le volume 'cache' est défini mais non monté. 
        # De plus, l'utilisation d'un PVC pour un cache de modèle est inhabituelle. 
        # Je supprime le volume pour simplifier, car il n'est pas utilisé dans le conteneur.
        # Si vous voulez le monter, vous devez ajouter 'volumeMounts' ici.
        
      # CORRECTION 4 : Le champ 'volumes' doit être au niveau 'spec' du Pod, pas du conteneur.
      # Je le supprime car il n'est pas utilisé.
      # volumes:
      # - name: cache
      #   persistentVolumeClaim:
      #     claimName: model-cache

---
# -------------------------------------------------------------------
# 2. SERVICE (Exposition Externe)
# -------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: social-score-service
spec:
  # CORRECTION 5 : Le champ 'selector' était dupliqué et mal placé.
  type: LoadBalancer
  selector:
    app: social-score-api # Doit correspondre au label du Pod
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080 # Le port du conteneur

---
# -------------------------------------------------------------------
# 3. HORIZONTAL POD AUTOSCALER (HPA)
# -------------------------------------------------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata: 
  name: social-score-autoscaling 
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: social-score-deployment
  minReplicas: 3
  maxReplicas: 15
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70 # Maintenir l'utilisation CPU moyenne à 70%

---
# -------------------------------------------------------------------
# 4. SERVICE REDONDANT (SUPPRIMÉ)
# -------------------------------------------------------------------
# CORRECTION 6 : Le dernier bloc était un Service redondant et mal formaté.
# Il est supprimé car le Service 'social-score-service' est déjà défini.
