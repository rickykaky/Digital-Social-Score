# cloudbuild.yaml

# ----------------------------------------------------------------------
# √âtape 0 : Compilation et Soumission du Pipeline Kubeflow
# ----------------------------------------------------------------------
# Compile le pipeline KFP v2 et le soumet √† Vertex AI Pipelines
steps:
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: bash
  args:
  - '-c'
  - |
    # D√©finir les variables
    export PROJECT_ID=$PROJECT_ID
    export PIPELINE_REGION=us-central1
    export BUCKET_NAME=${PROJECT_ID}-digital-social-score
    
    # Installer les d√©pendances
    echo "üì¶ Installation des d√©pendances KFP..."
    pip install -q kfp==2.0.0 google-cloud-aiplatform
    
    # Compiler le pipeline en fichier YAML
    echo "üî® Compilation du pipeline..."
    python -c "
from kfp.v2 import compiler
from pipeline import digital_score_pipeline

try:
    compiler.Compiler().compile(
        pipeline_func=digital_score_pipeline,
        package_path='digital_score_pipeline.yaml'
    )
    print('‚úì Pipeline compil√© avec succ√®s !')
except Exception as e:
    print(f'‚úó Erreur lors de la compilation: {e}')
    exit(1)
    "
    
    # V√©rifier que le fichier compil√© existe
    if [ ! -f digital_score_pipeline.yaml ]; then
      echo "‚úó Erreur: digital_score_pipeline.yaml non trouv√©"
      exit 1
    fi
    
    # Soumettre le pipeline √† Vertex AI Pipelines
    echo "üì§ Soumission du pipeline √† Vertex AI..."
    python submit_pipeline.py \
      --project ${PROJECT_ID} \
      --region ${PIPELINE_REGION} \
      --name "digital-social-score-pipeline-${COMMIT_SHA}" \
      --bucket ${BUCKET_NAME} || echo "‚ö†Ô∏è  Impossible de soumettre le pipeline (optionnel)"
    
    echo "‚úì √âtape 0 compl√©t√©e avec succ√®s"
  id: 'compile-and-submit-pipeline'

# ----------------------------------------------------------------------
# √âtape 1 : Tests Unitaires et Installation des D√©pendances
# ----------------------------------------------------------------------
# Utilise une image Python pour ex√©cuter les commandes de test et d'installation
- name: 'python:3.11'
  entrypoint: bash
  args:
  - '-c'
  - |
    # Installer les d√©pendances pour s'assurer que le code est valide
    echo "üìö Installation des d√©pendances..."
    pip install -q -r requirements.txt
    
    # Ex√©cuter les tests (optionnel - d√©commenter si vous avez des tests)
    # echo "üß™ Ex√©cution des tests..."
    # pytest tests/ || echo "‚ö†Ô∏è  Aucun test trouv√© (optionnel)"
    
    echo "‚úì √âtape 1 compl√©t√©e"
  id: 'install-and-test'

# ----------------------------------------------------------------------
# √âtape 2 : Construction de l'Image Docker
# ----------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '-t',
    # Utilise Artifact Registry (AR) et le tag de l'image bas√© sur le COMMIT_SHA
    'us-west1-docker.pkg.dev/$PROJECT_ID/social-score-repo/social-score-api:$COMMIT_SHA',
    '-t',
    'us-west1-docker.pkg.dev/$PROJECT_ID/social-score-repo/social-score-api:latest',
    '.'
  ]
  id: 'build-docker-image'

# ----------------------------------------------------------------------
# √âtape 3 : Pousser l'Image vers Artifact Registry
# ----------------------------------------------------------------------
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'push',
    'us-west1-docker.pkg.dev/$PROJECT_ID/social-score-repo/social-score-api:$COMMIT_SHA'
  ]
  id: 'push-to-artifact-registry'

# ----------------------------------------------------------------------
# √âtape 4 : D√©ploiement sur GKE
# ----------------------------------------------------------------------
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: bash
  args:
  - '-c'
  - |
    # 1. Configuration kubectl pour acc√©der au cluster GKE
    # Utilise les noms de cluster et de zone de votre projet
    gcloud container clusters get-credentials social-score-cluster \
      --zone us-west1-a \
      --project $PROJECT_ID
      
    # 2. Mise √† jour de l'image Docker dans le d√©ploiement Kubernetes
    # Utilise le nom de votre d√©ploiement et le tag de l'image construit
    kubectl set image deployment/social-score-deployment social-score-container=${REGION}-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/social-score-api:$COMMIT_SHA
    
    # 3. Attente de la fin du d√©ploiement (Rolling Update)
    kubectl rollout status deployment/social-score-deployment
  env:
  - 'REGION=us-west1'
  - 'REPO_NAME=social-score-repo'

# ----------------------------------------------------------------------
# D√©finition des Images de Sortie
# ----------------------------------------------------------------------
images:
- '${REGION}-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/social-score-api:$COMMIT_SHA'
