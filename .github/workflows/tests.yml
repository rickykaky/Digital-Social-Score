name: Tests & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"
  CACHE_VERSION: v1

jobs:
  # ==========================================================================
  # Job 1: Tests Unitaires
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Run unit tests
      run: pytest tests/unit -v --tb=short --junit-xml=reports/junit-unit.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-tests-results
        path: reports/junit-unit.xml

  # ==========================================================================
  # Job 2: Tests d'Int√©gration
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run integration tests
      run: pytest tests/integration -v --tb=short --junit-xml=reports/junit-integration.xml
      timeout-minutes: 10
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-tests-results
        path: reports/junit-integration.xml

  # ==========================================================================
  # Job 3: Tests Pipeline ML
  # ==========================================================================
  pipeline-tests:
    name: Pipeline Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Run pipeline tests
      run: pytest tests/pipeline -v --tb=short --junit-xml=reports/junit-pipeline.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: pipeline-tests-results
        path: reports/junit-pipeline.xml

  # ==========================================================================
  # Job 4: Code Coverage
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Generate coverage report
      run: pytest tests/ --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

  # ==========================================================================
  # Job 5: Linting & Code Quality
  # ==========================================================================
  lint:
    name: Linting & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Format check with black
      run: |
        black src/ tests/ --check --diff
    
    - name: Sort imports with isort
      run: |
        isort src/ tests/ --check-only --diff

  # ==========================================================================
  # Job 6: Type Checking
  # ==========================================================================
  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Type check with mypy
      run: |
        mypy src/ --ignore-missing-imports --junit-xml=reports/mypy.xml
      continue-on-error: true
    
    - name: Upload mypy results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: mypy-results
        path: reports/mypy.xml

  # ==========================================================================
  # Job 7: Security Check
  # ==========================================================================
  security:
    name: Security Scan (bandit)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit
    
    - name: Run bandit security scan
      run: |
        bandit -r src/ -f json -o reports/bandit.json
      continue-on-error: true
    
    - name: Upload security results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bandit-results
        path: reports/bandit.json

  # ==========================================================================
  # Job 8: Tests de Charge et Performance (NOUVEAU) ‚≠ê
  # ==========================================================================
  performance-tests:
    name: Load & Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    services:
      # Service pour h√©berger l'API lors des tests
      api:
        image: ghcr.io/${{ github.repository_owner }}/digital-social-score:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd="curl -f http://localhost:8000/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install locust k6 aiohttp
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Wait for API to be ready
      run: |
        python -c "
        import time
        import requests
        for i in range(30):
          try:
            requests.get('http://localhost:8000/health')
            print('‚úÖ API is ready!')
            exit(0)
          except:
            print(f'‚è≥ Waiting for API... ({i+1}/30)')
            time.sleep(1)
        exit(1)
        "
    
    - name: Run load tests (Locust)
      run: |
        locust -f test_charge/locustfile.py \
          --headless \
          -u 100 \
          -r 10 \
          --run-time 5m \
          --host http://localhost:8000 \
          --csv=reports/locust_stats \
          --logfile=reports/locust.log
    
    - name: Run performance tests (Custom)
      run: |
        pytest test_charge/test.ipynb -v \
          --tb=short \
          --junit-xml=reports/junit-performance.xml \
          -m "not slow"
    
    - name: Analyze performance metrics
      run: |
        python -c "
        import json
        import sys
        
        # Lire les m√©triques de Locust
        try:
          with open('reports/locust_stats_stats.csv', 'r') as f:
            lines = f.readlines()
            print('\nüìä M√âTRIQUES DE CHARGE:')
            print('=' * 60)
            for line in lines[:10]:
              print(line.strip())
            
            # Parser les donn√©es
            for line in lines[1:]:
              parts = line.split(',')
              if len(parts) >= 5:
                endpoint = parts[0]
                requests = parts[1]
                failures = parts[2]
                median = parts[3]
                p95 = parts[4]
                print(f'\nüîó {endpoint}')
                print(f'   Requ√™tes: {requests}')
                print(f'   Latence m√©diane: {median}ms')
                print(f'   P95: {p95}ms')
        except Exception as e:
          print(f'‚ö†Ô∏è  Impossible de lire les m√©triques: {e}')
        "
    
    - name: Check performance thresholds
      run: |
        python -c "
        import csv
        
        # V√©rifier les seuils de performance
        thresholds = {
          'latency_p95': 1000,  # Max 1s √† P95
          'error_rate': 5,       # Max 5% d'erreurs
          'rps': 100             # Min 100 req/s
        }
        
        print('\n‚úÖ V√âRIFICATION DES SEUILS DE PERFORMANCE:')
        print('=' * 60)
        
        try:
          with open('reports/locust_stats_stats.csv', 'r') as f:
            reader = csv.DictReader(f)
            for row in reader:
              if row.get('Name') == 'Total':
                p95 = float(row.get('95%', 0))
                failures = float(row.get('Failure Rate', 0).rstrip('%'))
                rps = float(row.get('RPS', 0))
                
                print(f'üìä Latence P95: {p95}ms (seuil: {thresholds[\"latency_p95\"]}ms)')
                print(f'üìä Taux d\'erreur: {failures}% (seuil: {thresholds[\"error_rate\"]}%)')
                print(f'üìä RPS: {rps} (seuil: {thresholds[\"rps\"]})')
                
                if p95 > thresholds['latency_p95']:
                  print('‚ùå ERREUR: Latence trop √©lev√©e!')
                  exit(1)
                if failures > thresholds['error_rate']:
                  print('‚ùå ERREUR: Taux d\'erreur trop haut!')
                  exit(1)
                if rps < thresholds['rps']:
                  print('‚ùå ERREUR: RPS insuffisant!')
                  exit(1)
                
                print('‚úÖ Tous les seuils respect√©s!')
        except Exception as e:
          print(f'‚ö†Ô∏è  Impossible de v√©rifier les seuils: {e}')
        "
    
    - name: Upload performance reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports
        path: reports/

  # ==========================================================================
  # Job 9: Summary & Status
  # ==========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, pipeline-tests, coverage, lint, type-check, performance-tests]
    if: always()
    
    steps:
    - name: ‚úÖ All Tests Passed
      if: ${{ needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.pipeline-tests.result == 'success' && needs.performance-tests.result == 'success' }}
      run: |
        echo "‚úÖ All tests passed successfully!"
        echo "üìä Coverage: Check the Coverage Report artifact"
        echo "‚ö° Performance: Check the Performance Reports artifact"
    
    - name: ‚ùå Some Tests Failed
      if: ${{ failure() }}
      run: |
        echo "‚ùå Some tests failed. Check the logs above."
        exit 1

  # ==========================================================================
  # Job 10: Build Docker Image (si tous les tests passent)
  # ==========================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint, performance-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unit-tests.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: digital-social-score:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max