name: Tests & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"
  CACHE_VERSION: v1

jobs:
  # ==========================================================================
  # Job 1: Tests Unitaires
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Run unit tests
      run: pytest tests/unit -v --tb=short --junit-xml=reports/junit-unit.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-tests-results
        path: reports/junit-unit.xml

  # ==========================================================================
  # Job 2: Tests d'Int√©gration
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run integration tests
      run: pytest tests/integration -v --tb=short --junit-xml=reports/junit-integration.xml
      timeout-minutes: 10
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-tests-results
        path: reports/junit-integration.xml

  # ==========================================================================
  # Job 3: Tests Pipeline ML
  # ==========================================================================
  pipeline-tests:
    name: Pipeline Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Run pipeline tests
      run: pytest tests/pipeline -v --tb=short --junit-xml=reports/junit-pipeline.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-tests-results
        path: reports/junit-pipeline.xml

  # ==========================================================================
  # Job 4: Code Coverage
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Download NLTK data
      run: |
        python -m nltk.downloader punkt stopwords wordnet averaged_perceptron_tagger maxent_ne_chunker words
    
    - name: Generate coverage report
      run: pytest tests/ --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

  # ==========================================================================
  # Job 5: Linting & Code Quality
  # ==========================================================================
  lint:
    name: Linting & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-test.txt
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Format check with black
      run: |
        black src/ tests/ --check --diff
    
    - name: Sort imports with isort
      run: |
        isort src/ tests/ --check-only --diff

  # ==========================================================================
  # Job 6: Type Checking
  # ==========================================================================
  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Type check with mypy
      run: |
        mypy src/ --ignore-missing-imports --junit-xml=reports/mypy.xml
      continue-on-error: true
    
    - name: Upload mypy results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mypy-results
        path: reports/mypy.xml

  # ==========================================================================
  # Job 7: Security Check
  # ==========================================================================
  security:
    name: Security Scan (bandit)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit
    
    - name: Run bandit security scan
      run: |
        bandit -r src/ -f json -o reports/bandit.json
      continue-on-error: true
    
    - name: Upload security results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bandit-results
        path: reports/bandit.json

  # ==========================================================================
  # Job 8: Summary & Status
  # ==========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, pipeline-tests, coverage, lint, type-check]
    if: always()
    
    steps:
    - name: ‚úÖ All Tests Passed
      if: ${{ needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.pipeline-tests.result == 'success' }}
      run: |
        echo "‚úÖ All tests passed successfully!"
        echo "üìä Coverage: Check the Coverage Report artifact"
    
    - name: ‚ùå Some Tests Failed
      if: ${{ failure() }}
      run: |
        echo "‚ùå Some tests failed. Check the logs above."
        exit 1

  # ==========================================================================
  # Job 9: Build Docker Image (si tous les tests passent)
  # ==========================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unit-tests.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: digital-social-score:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
